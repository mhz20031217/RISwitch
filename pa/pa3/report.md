# PA3 实验报告

**实验进度**: 我完成了所有的必做题和大部分选做题。

## 必做题

### 实现异常响应机制

在实现 RISC-V 的异常相应机制时，花费了不少时间，主要是不清楚“不需要关心特权级切换相关的内容”后，究竟应该怎样操作 `mstatus` 寄存器中的各种标志位。

参考资料
- [1] RISC-V Vol.2
- [2] [RISC-V 异常处理流程介绍](https://tinylab.org/riscv-irq-pipeline-introduction/)
- [3] https://www.bilibili.com/video/BV1aP411R7dM/?spm_id_from=333.788.recommend_more_video.4
- [4] https://www.bilibili.com/video/BV11M4y1t7nv/?spm_id_from=333.999.0.0

### 把按键输入抽象成文件

`/dev/events` 的设计包含了各种大坑，在后续的实验中我犯了许多错误，包括但不限于

1. 忘记删除事件末尾的 `\n`，Debug 3h；
2. 由于不会正确使用 `sprintf` 和 `sscanf` 在 NDL 中手写事件解析器（后来改回了 `sscanf`）；
3. 没有考虑键值对的顺序可能不同，在 Native 上 Crash，Debug 1h；
4. ...

### 实现 `gettimeofday`

我终于解决了 NEMU 时钟的 Bug！问题在于 `AM_TIMER_UPTIME` 寄存器为 64 位，需要分两次读取，然而 NEMU 是在读取高 32 位时更新寄存器值。我的 AM 实现是先读低 32 位，再读高 32 位。

PA2 的 OJ 没有测试时钟的实现，实际上我没有解决 NEMU 在时钟部分的问题。在 YSYX 的组会上，一位同学提到他没有修改相关代码，但是结果仍然正确。助教提到坑和寄存器有 64 位有关。我这才想到问题的原因。（2023.11.06 修复了这个问题并更新了 PA2 实验报告）

## 选做题

### 什么是操作系统? (建议二周目思考)

操作系统是位于 ISA 和用户应用程序中间的抽象层，包含加载器、文件系统、进程调度、驱动程序等部分。

### 异常号的保存

#TODO

### 对比异常处理与函数调用

异常处理保存的上下文比函数调用多了函数调用没有保存的通用寄存器和各种控制状态寄存器。原因是：异常处理的目的是

### 堆和栈在哪里?

堆和栈是程序运行时创建的，自然不会放入可执行文件里面。

在 AM 中，栈实际上就是从一个指定的内存位置 `_start_pointer` 开始的。在 `abstract-machine/scripts/linker.ld` 中，指定了初始的栈顶指针在 `.bss` 段后 4KB 对齐加上 32KB 的位置。堆区从栈区后 4KB 对齐的位置开始。

```ld
  _stack_top = ALIGN(0x1000);
  . = _stack_top + 0x8000;
  _stack_pointer = .;
  end = .;
  _end = .;
  _heap_start = ALIGN(0x1000);
```

### 如何识别不同格式的可执行文件?

1. 通过 Magic Number 判断是否为 ELF 文件；
2. 通过解析 Elf_Header 判断 ELF 文件运行的平台是否正确。

### 冗余的属性? 为什么要清零?

ELF 可执行文件（程序）是内存中的进程的映像，文件中 `FileSiz` 的大小不一定和内存 `MemSiz` 中的大小相同，需要初始化的部分需要在文件中保存，而没有初始化的内存区域无需保存。比如 `.bss` 节，是 C 中未初始化的全局变量的内存区域。C 标准规定，没有初始化的全局变量内存区域初始化为 0。

### 检查ELF文件的魔数  检测ELF文件的ISA类型

已完成。

### 系统调用的必要性

如果批处理序列中的每一个程序都知道下一个加载的程序是哪一个（而且也能够将下一个程序正确加载），我认为可以不需要系统调用（不需要操作系统），也可以把 AM 的 API 暴露给批处理系统中的程序。

如果规定是由操作系统来加载程序，那么系统调用是必须的。因为想要达到批处理系统的效果，一个程序结束后必须有方法告知操作系统，只有系统调用才能实现这一点。

### RISC-V系统调用号的传递

在 RISC-V ABI 中，规定 `a0` 寄存器作为第一个参数和返回值的寄存器，如果在 `a0` 中放置系统调用号，那么第一个参数将被覆盖。我猜想是为了让系统调用参数传递和普通参数传递保持一致，将系统调用号的转递放到了 `a7`。

### 实现居中的画布

已实现。
