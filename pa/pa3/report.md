# PA3 å®éªŒæŠ¥å‘Š

**å®éªŒè¿›åº¦**: æˆ‘å®Œæˆäº†æ‰€æœ‰çš„å¿…åšé¢˜å’Œå¤§éƒ¨åˆ†é€‰åšé¢˜ã€‚

## å¿…åšé¢˜

### é‡æ–°ç»„ç»‡ Context ç»“æ„ä½“ ç†è§£ä¸Šä¸‹æ–‡ç»“æ„ä½“çš„å‰ä¸–ä»Šç”Ÿ ç†è§£ç©¿è¶Šæ—¶ç©ºçš„æ—…ç¨‹

ç”±äºç°é˜¶æ®µæ²¡æœ‰å¤–éƒ¨ä¸­æ–­ï¼Œæ¥ä¸‹æ¥çš„å›ç­”æ˜¯ä»ç”¨æˆ·ç¨‹åº `ecall` ä¸€ç›´åˆ°ç”¨æˆ·ç¨‹åºå¾—åˆ°ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼çš„è¿‡ç¨‹ã€‚`yield test` çš„å†…å®¹åœ¨å…¶ä¸­ç”¨é»‘ä½“æ ‡å‡ºã€‚

#### åˆå§‹åŒ–é˜¶æ®µ

1. ç³»ç»Ÿçº§ç¨‹åºï¼ˆNanos-liteï¼‰ï¼š`nanos-lite/src/irq.c:init_irq`ï¼Œ`cte_init(do_event)` åœ¨ AM ä¸­æ³¨å†Œç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° `do_event`ï¼›
2. AMï¼š`abstract-machine/am/src/riscv/nemu/cte.c:cte_init`ï¼Œè®¾ç½® AM çš„å¤„ç†å‡½æ•° `asm volatile("csrw mtvec, %0" : : "r"(__am_asm_trap));`ï¼Œæ³¨å†Œæ“ä½œç³»ç»Ÿçš„å¤„ç†å‡½æ•° `user_handler = handler;` å¼‚å¸¸å¤„ç†æ—¶ï¼ŒNEMU å°†å…ˆè·³è½¬åˆ° `__am_asm_trap`ï¼Œç„¶åç»è½¬å‘ï¼Œå°†ä¸Šä¸‹æ–‡ç»“æ„ä½“æŒ‡é’ˆä¼ é€’ç»™æ“ä½œç³»ç»Ÿçš„å¤„ç†å‡½æ•°ã€‚
3. NEMUï¼š`csrw mtvec, %0`ï¼Œå°† `mtvec` è®¾ç½®ä¸º AM å¤„ç†å‡½æ•°ã€‚

**`yield()`**ï¼šæ³¨å†Œçš„ `user_handler` æ˜¯ `am-kernels/tests/am-tests/src/tests/intr.c:simple_trap`ï¼›

#### è¿è¡Œé˜¶æ®µ

1. ç”¨æˆ·çº§ç¨‹åºï¼ˆNavy Appsï¼‰ï¼šlibc æœ€ç»ˆè°ƒç”¨ libosï¼Œlibos åœ¨å¯„å­˜å™¨ä¸­è®¾ç½®å¥½ç³»ç»Ÿè°ƒç”¨å·å’Œå‚æ•° 

    ```c
    // navy-apps/libs/libos/src/syscall.c
    asm volatile (SYSCALL : "=r" (ret) : "r"(_gpr1), "r"(_gpr2), "r"(_gpr3), "r"(_gpr4));
    ```

    æ‰§è¡Œ `ecall` æŒ‡ä»¤ï¼Œå¼€å§‹ç³»ç»Ÿè°ƒç”¨ï¼›

    **`yield()`**ï¼šå³ä¸º `li a7, -1; ecall`ã€‚å¼€å§‹è‡ªé™·ã€‚

2. NEMUï¼šCPU è‡ªåŠ¨è·³è½¬åˆ° `mtvec` ä¸­ `__am_asm_trap` çš„ä½ç½®æ‰§è¡Œ

    æ ¹æ®æ‰‹å†Œï¼ŒCPU è‡ªåŠ¨ç»å†å¦‚ä¸‹çŠ¶æ€è½¬æ¢
    1. `mstatus` æ›´æ”¹æƒé™æ¨¡å¼ï¼Œå…³ä¸­æ–­ï¼šå°†å¼‚å¸¸å‰çš„æƒé™ä¿å­˜åˆ° `mstatus.MPP`ï¼Œå°† `mstatus.MIE` ä¿å­˜åˆ° `mstatus.MPIE` åç½®é›¶ï¼ˆä¿å­˜ä¸­æ–­çŠ¶æ€ï¼Œå…³ä¸­æ–­ï¼‰ï¼›
    2. `mcause` è®¾ç½®å¼‚å¸¸æ¥æºï¼Œ`mtval` å†™å…¥é™„åŠ ä¿¡æ¯ï¼ˆåè€… PA å¿½ç•¥ï¼‰ï¼Œ`ecall` æŒ‡ä»¤äº§ç”Ÿçš„å¼‚å¸¸å·æˆ‘çš„å®ç°ä¸­ä¸º 11ï¼›
    3. `mepc` ä¿å­˜å¼‚å¸¸å‰ `pc`ã€‚
    4. è·³è½¬åˆ° `mtvec`ã€‚

    ```c
    // nemu/src/isa/riscv32/inst.c
    INSTPAT("000000000000 00000 000 00000 11100 11", ecall   , I,
        isa_raise_intr(11, s->pc);
        s->dnpc = C(CSR_MTVEC_IDX);
    );
    ```

    åœ¨æˆ‘çš„å®ç°ä¸­ï¼Œæ ¹æ® PA çš„è¦æ±‚ï¼Œåªå®ç°äº† M-Modeï¼Œæ‰€ä»¥å¼‚å¸¸å·ä¸º 11 ï¼ˆEnvironment Call from M-Modeï¼‰ã€‚

    ```c
    // nemu/src/isa/riscv32/system/intr.c:isa_raise_intr
    #ifdef CONFIG_ETRACE
    if (ETRACE_COND)
        Info("[etrace] Exception No.%d at epc: 0x%x", NO, epc);
    #endif
    
    C(CSR_MEPC_IDX) = epc;
    C(CSR_MCAUSE_IDX) = NO; // use Exception-from-M-mode
    word_t mstatus = C(CSR_MSTATUS_IDX);
    word_t mie = getbit(mstatus, 3);
    mstatus = (mie) ? setbit(mstatus, 7) : rstbit(mstatus, 7);
    mstatus = rstbit(mstatus, 3);
    C(CSR_MSTATUS_IDX) = mstatus;
    
    return epc + 4;
    ```

    **`PC + 4` çš„å¤„ç†**ï¼š`ecall` æŒ‡ä»¤å­˜çš„æ˜¯ `pc` è€Œä¸æ˜¯ `pc + 4`ï¼Œ`+4` çš„æ“ä½œæ˜¯ç”± AM çš„å¼‚å¸¸å¤„ç†ç¨‹åºè¿›è¡Œçš„ã€‚åœ¨ä¸‹ä¸€æ¡è¯¦ç»†å±•å¼€ã€‚

3. AM å°è£…äº‹ä»¶ä¸º `Context` ç»“æ„ä½“ï¼Œè½¬å‘äº‹ä»¶

    NEMU è‡ªåŠ¨è·³è½¬åˆ° `abstract-machine/am/src/riscv/nemu/trap.S:__am_asm_trap`ï¼Œå¼€å§‹ä¿å­˜ç°åœºåˆ° `Context` ç»“æ„ä½“

    ```asm
    addi sp, sp, -CONTEXT_SIZE

    MAP(REGS, PUSH)

    csrr t0, mcause
    csrr t1, mstatus
    csrr t2, mepc

    STORE t0, OFFSET_CAUSE(sp)
    STORE t1, OFFSET_STATUS(sp)
    STORE t2, OFFSET_EPC(sp)
    ```

    ä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼Œåˆ†åˆ«æ˜¯ `x0` ~ `x31`, `mcause`, `mstatus`, `mepc`ï¼ˆå®é™…ä¸Šæ²¡æœ‰ä¿å­˜å’Œæ¢å¤ `x0`, `x2`ï¼‰ã€‚

    æ‰€ä»¥ `Context` ç»“æ„ä½“é‡æ„å¦‚ä¸‹

    ```c
    struct Context {
        uintptr_t gpr[NR_REGS];
        uintptr_t mcause, mstatus, mepc;

        void *pdir;
    };
    ```

    **`PC + 4` çš„å¤„ç†**ï¼šåœ¨ `abstract-machine/am/src/riscv/nemu/cte.c:__am_irq_handle` ä¸­ï¼Œåˆ¤æ–­å¦‚æœæ˜¯è‡ªé™·å¼‚å¸¸ï¼Œåˆ™å°† `pc + 4`ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°é—®é¢˜è¿˜æ²¡æœ‰è§£å†³ï¼š`+4` æ“ä½œæ˜¯åœ¨è°ƒç”¨ç”¨æˆ·å¤„ç†å‡½æ•°ä¹‹å‰è¿˜æ˜¯ä¹‹åï¼Ÿæˆ‘çš„å®ç°æ˜¯åœ¨è°ƒç”¨ä¹‹å‰ï¼ˆAM çš„æ–‡æ¡£ä¸­æ²¡æœ‰å†™è¿™ä¸ªæ“ä½œæ˜¯ç”± AM åšè¿˜æ˜¯æ“ä½œç³»ç»Ÿåšï¼Œä»¥åå¯èƒ½éœ€è¦è°ƒæ•´ï¼‰ã€‚

    `__am_irq_handle` åˆ¤æ–­å¼‚å¸¸å·

    ```c
    switch (c->mcause) {
        case 11:
            if (c->GPR1 < 20) ev.event = EVENT_SYSCALL;
            else ev.event = EVENT_YIELD;
    ```

4. ç³»ç»Ÿçº§ç¨‹åºï¼ˆNanos-liteï¼‰ï¼šä» `GPR1`, `GPR2`, `GPR3`, `GPR4` ä¸­å–å‡ºè°ƒç”¨å·å’Œå‚æ•°ï¼Œå¼€å§‹ç³»ç»Ÿè°ƒç”¨ï¼Œè¿”å›å€¼å­˜ `GPRx`ï¼›

5. AM `__am_asm_trap` å­˜ä¿®æ”¹åçš„ç°åœºï¼ˆ`pc + 4` è¢«å†™å…¥ `mepc`ï¼‰ `mret`ï¼›

6. NEMU è·³è½¬åˆ° `mepc` ä½ç½®ï¼Œå³åŸç”¨æˆ·ç¨‹åº `ecall` çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œç”¨æˆ·ç¨‹åºè·å¾—ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼ã€‚

### å®ç°å¼‚å¸¸å“åº”æœºåˆ¶ è¯†åˆ«è‡ªé™·äº‹ä»¶ æ¢å¤ä¸Šä¸‹æ–‡

åœ¨å®ç° RISC-V çš„å¼‚å¸¸ç›¸åº”æœºåˆ¶æ—¶ï¼ŒèŠ±è´¹äº†ä¸å°‘æ—¶é—´ï¼Œä¸»è¦æ˜¯ä¸æ¸…æ¥šâ€œä¸éœ€è¦å…³å¿ƒç‰¹æƒçº§åˆ‡æ¢ç›¸å…³çš„å†…å®¹â€åï¼Œç©¶ç«Ÿåº”è¯¥æ€æ ·æ“ä½œ `mstatus` å¯„å­˜å™¨ä¸­çš„å„ç§æ ‡å¿—ä½ã€‚

```
Hello, AM World @ riscv32
  t = timer, d = device, y = yield
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
```

#### å‚è€ƒèµ„æ–™
- [1] RISC-V Vol.2
- [2] [RISC-V å¼‚å¸¸å¤„ç†æµç¨‹ä»‹ç»](https://tinylab.org/riscv-irq-pipeline-introduction/)
- [3] [X2Wç¬¬å…­æ¬¡ç»„ä¼šï¼šå¼‚å¸¸å§”æ‰˜æœºåˆ¶](https://www.bilibili.com/video/BV1aP411R7dM/?spm_id_from=333.788.recommend_more_video.4)
- [4] https://www.bilibili.com/video/BV11M4y1t7nv/?spm_id_from=333.999.0.0

### å®ç° etrace  å®ç° strace

etrace å·²å®ç°ï¼Œåœ¨ NEMU çš„ Kconfig ä¸­å¯ç”¨ï¼›
strace å·²å®ç°ï¼Œåœ¨ NanOS-lite çš„ `debug.h` ä¸­å¯ç”¨ `ENABLE_STRACE` å®å¯ç”¨ï¼Œå®ç°äº†é’ˆå¯¹æ–‡ä»¶ç³»ç»Ÿçš„å¯è¯»æ€§ä¼˜åŒ–åŠŸèƒ½ã€‚

![strace](img/strace.png)

### å®ç°å †åŒºç®¡ç†

åš PA å‰ï¼Œæˆ‘ä»¥ä¸ºå †åŒºç®¡ç†éœ€è¦æ‰‹å†™ `malloc` çš„ç®—æ³•ï¼Œç°åœ¨å‘ç°é‚£æ˜¯ C åº“çš„å·¥ä½œã€‚

### hello ç¨‹åºæ˜¯ä»€ä¹ˆ, å®ƒä»è€Œä½•æ¥, è¦åˆ°å“ªé‡Œå»

#TODO

### æŠŠæŒ‰é”®è¾“å…¥æŠ½è±¡æˆæ–‡ä»¶

`/dev/events` çš„è®¾è®¡åŒ…å«äº†å„ç§å¤§å‘ï¼Œåœ¨åç»­çš„å®éªŒä¸­æˆ‘çŠ¯äº†è®¸å¤šé”™è¯¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº

1. å¿˜è®°åˆ é™¤äº‹ä»¶æœ«å°¾çš„ `\n`ï¼ŒDebug 3hï¼›
2. ç”±äºä¸ä¼šæ­£ç¡®ä½¿ç”¨ `sprintf` å’Œ `sscanf` åœ¨ NDL ä¸­æ‰‹å†™äº‹ä»¶è§£æå™¨ï¼ˆåæ¥æ”¹å›äº† `sscanf`ï¼‰ï¼›
3. æ²¡æœ‰è€ƒè™‘é”®å€¼å¯¹çš„é¡ºåºå¯èƒ½ä¸åŒï¼Œåœ¨ Native ä¸Š Crashï¼ŒDebug 1hï¼›
4. ...

### å®ç° `gettimeofday`

æˆ‘ç»ˆäºè§£å†³äº† NEMU æ—¶é’Ÿçš„ Bugï¼é—®é¢˜åœ¨äº `AM_TIMER_UPTIME` å¯„å­˜å™¨ä¸º 64 ä½ï¼Œéœ€è¦åˆ†ä¸¤æ¬¡è¯»å–ï¼Œç„¶è€Œ NEMU æ˜¯åœ¨è¯»å–é«˜ 32 ä½æ—¶æ›´æ–°å¯„å­˜å™¨å€¼ã€‚æˆ‘çš„ AM å®ç°æ˜¯å…ˆè¯»ä½ 32 ä½ï¼Œå†è¯»é«˜ 32 ä½ã€‚

PA2 çš„ OJ æ²¡æœ‰æµ‹è¯•æ—¶é’Ÿçš„å®ç°ï¼Œå®é™…ä¸Šæˆ‘æ²¡æœ‰è§£å†³ NEMU åœ¨æ—¶é’Ÿéƒ¨åˆ†çš„é—®é¢˜ã€‚åœ¨ YSYX çš„ç»„ä¼šä¸Šï¼Œä¸€ä½åŒå­¦æåˆ°ä»–æ²¡æœ‰ä¿®æ”¹ç›¸å…³ä»£ç ï¼Œä½†æ˜¯ç»“æœä»ç„¶æ­£ç¡®ã€‚åŠ©æ•™æåˆ°å‘å’Œå¯„å­˜å™¨æœ‰ 64 ä½æœ‰å…³ã€‚æˆ‘è¿™æ‰æƒ³åˆ°é—®é¢˜çš„åŸå› ã€‚ï¼ˆ2023.11.06 ä¿®å¤äº†è¿™ä¸ªé—®é¢˜å¹¶æ›´æ–°äº† PA2 å®éªŒæŠ¥å‘Šï¼‰

### å®ç°æ›´å¤šçš„ fixedptc API

å·²ä¸º libfixedptc åº“ç¼–å†™æµ‹è¯•ï¼Œä½äº `navy-apps/tests/fixedptc-test`

### è¿è¡Œ NSlider

![nslider](img/nslider.png)

### è¿è¡Œ NTerm

![nterm](img/nterm1.png)
![nterm](img/nterm2.png)

### è¿è¡Œ Flappy Bird

![bird](img/bird.png)

### è¿è¡Œä»™å‰‘å¥‡ä¾ ä¼ 

ä¸€å¼€å§‹ï¼Œæˆ‘è°ƒè‰²æ¿çš„åƒç´ æ ¼å¼æ²¡æœ‰è¿›è¡Œè½¬æ¢ï¼Œé€ æˆä»™å‰‘å‘ˆè“è‰²

![pal-blue](img/pal-blue.png)

![pal](img/pal01.png)
![pal](img/pal02.png)
![pal](img/pal03.png)
![pal](img/pal04.png)
![pal](img/pal05.png)
![pal](img/pal06.png)
![pal](img/pal07.png)

ç›®å‰ä»™å‰‘çš„å­—ä½“æ¸²æŸ“ä»ç„¶æœ‰é—®é¢˜ï¼Œè¿˜æ²¡æœ‰ Debugã€‚

![pal-fontrender](img/pal-font.png)

#TODO

## é€‰åšé¢˜

### ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ? (å»ºè®®äºŒå‘¨ç›®æ€è€ƒ)

æ“ä½œç³»ç»Ÿæ˜¯ä½äº ISA å’Œç”¨æˆ·åº”ç”¨ç¨‹åºä¸­é—´çš„æŠ½è±¡å±‚ï¼ŒåŒ…å«åŠ è½½å™¨ã€æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹è°ƒåº¦ã€é©±åŠ¨ç¨‹åºç­‰éƒ¨åˆ†ã€‚

### å¼‚å¸¸å·çš„ä¿å­˜

#TODO

### å¯¹æ¯”å¼‚å¸¸å¤„ç†ä¸å‡½æ•°è°ƒç”¨

å¼‚å¸¸å¤„ç†ä¿å­˜çš„ä¸Šä¸‹æ–‡æ¯”å‡½æ•°è°ƒç”¨å¤šäº†å‡½æ•°è°ƒç”¨æ²¡æœ‰ä¿å­˜çš„é€šç”¨å¯„å­˜å™¨å’Œå„ç§æ§åˆ¶çŠ¶æ€å¯„å­˜å™¨ã€‚åŸå› æ˜¯ï¼šå¼‚å¸¸å¤„ç†çš„ç›®çš„æ˜¯

### ä» `+4` æ“ä½œçœ‹ CISC å’Œ RISC



### å †å’Œæ ˆåœ¨å“ªé‡Œ?

å †å’Œæ ˆæ˜¯ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºçš„ï¼Œè‡ªç„¶ä¸ä¼šæ”¾å…¥å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢ã€‚

åœ¨ AM ä¸­ï¼Œæ ˆå®é™…ä¸Šå°±æ˜¯ä»ä¸€ä¸ªæŒ‡å®šçš„å†…å­˜ä½ç½® `_start_pointer` å¼€å§‹çš„ã€‚åœ¨ `abstract-machine/scripts/linker.ld` ä¸­ï¼ŒæŒ‡å®šäº†åˆå§‹çš„æ ˆé¡¶æŒ‡é’ˆåœ¨ `.bss` æ®µå 4KB å¯¹é½åŠ ä¸Š 32KB çš„ä½ç½®ã€‚å †åŒºä»æ ˆåŒºå 4KB å¯¹é½çš„ä½ç½®å¼€å§‹ã€‚

```ld
  _stack_top = ALIGN(0x1000);
  . = _stack_top + 0x8000;
  _stack_pointer = .;
  end = .;
  _end = .;
  _heap_start = ALIGN(0x1000);
```

### å¦‚ä½•è¯†åˆ«ä¸åŒæ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶?

1. é€šè¿‡ Magic Number åˆ¤æ–­æ˜¯å¦ä¸º ELF æ–‡ä»¶ï¼›
2. é€šè¿‡è§£æ Elf_Header åˆ¤æ–­ ELF æ–‡ä»¶è¿è¡Œçš„å¹³å°æ˜¯å¦æ­£ç¡®ã€‚

### å†—ä½™çš„å±æ€§? ä¸ºä»€ä¹ˆè¦æ¸…é›¶?

ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆç¨‹åºï¼‰æ˜¯å†…å­˜ä¸­çš„è¿›ç¨‹çš„æ˜ åƒï¼Œæ–‡ä»¶ä¸­ `FileSiz` çš„å¤§å°ä¸ä¸€å®šå’Œå†…å­˜ `MemSiz` ä¸­çš„å¤§å°ç›¸åŒï¼Œéœ€è¦åˆå§‹åŒ–çš„éƒ¨åˆ†éœ€è¦åœ¨æ–‡ä»¶ä¸­ä¿å­˜ï¼Œè€Œæ²¡æœ‰åˆå§‹åŒ–çš„å†…å­˜åŒºåŸŸæ— éœ€ä¿å­˜ã€‚æ¯”å¦‚ `.bss` èŠ‚ï¼Œæ˜¯ C ä¸­æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡çš„å†…å­˜åŒºåŸŸã€‚C æ ‡å‡†è§„å®šï¼Œæ²¡æœ‰åˆå§‹åŒ–çš„å…¨å±€å˜é‡å†…å­˜åŒºåŸŸåˆå§‹åŒ–ä¸º 0ã€‚

### æ£€æŸ¥ ELF æ–‡ä»¶çš„é­”æ•°  æ£€æµ‹ ELF æ–‡ä»¶çš„ ISA ç±»å‹

å·²å®Œæˆã€‚

### ç³»ç»Ÿè°ƒç”¨çš„å¿…è¦æ€§

å¦‚æœæ‰¹å¤„ç†åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªç¨‹åºéƒ½çŸ¥é“ä¸‹ä¸€ä¸ªåŠ è½½çš„ç¨‹åºæ˜¯å“ªä¸€ä¸ªï¼ˆè€Œä¸”ä¹Ÿèƒ½å¤Ÿå°†ä¸‹ä¸€ä¸ªç¨‹åºæ­£ç¡®åŠ è½½ï¼‰ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥ä¸éœ€è¦ç³»ç»Ÿè°ƒç”¨ï¼ˆä¸éœ€è¦æ“ä½œç³»ç»Ÿï¼‰ï¼Œä¹Ÿå¯ä»¥æŠŠ AM çš„ API æš´éœ²ç»™æ‰¹å¤„ç†ç³»ç»Ÿä¸­çš„ç¨‹åºã€‚

å¦‚æœè§„å®šæ˜¯ç”±æ“ä½œç³»ç»Ÿæ¥åŠ è½½ç¨‹åºï¼Œé‚£ä¹ˆç³»ç»Ÿè°ƒç”¨æ˜¯å¿…é¡»çš„ã€‚å› ä¸ºæƒ³è¦è¾¾åˆ°æ‰¹å¤„ç†ç³»ç»Ÿçš„æ•ˆæœï¼Œä¸€ä¸ªç¨‹åºç»“æŸåå¿…é¡»æœ‰æ–¹æ³•å‘ŠçŸ¥æ“ä½œç³»ç»Ÿï¼Œåªæœ‰ç³»ç»Ÿè°ƒç”¨æ‰èƒ½å®ç°è¿™ä¸€ç‚¹ã€‚

### RISC-V ç³»ç»Ÿè°ƒç”¨å·çš„ä¼ é€’

åœ¨ RISC-V ABI ä¸­ï¼Œè§„å®š `a0` å¯„å­˜å™¨ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å’Œè¿”å›å€¼çš„å¯„å­˜å™¨ï¼Œå¦‚æœåœ¨ `a0` ä¸­æ”¾ç½®ç³»ç»Ÿè°ƒç”¨å·ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°å°†è¢«è¦†ç›–ã€‚æˆ‘çŒœæƒ³æ˜¯ä¸ºäº†è®©ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¼ é€’å’Œæ™®é€šå‚æ•°ä¼ é€’ä¿æŒä¸€è‡´ï¼Œå°†ç³»ç»Ÿè°ƒç”¨å·çš„è½¬é€’æ”¾åˆ°äº† `a7`ã€‚

### å®ç°å±…ä¸­çš„ç”»å¸ƒ

å·²å®ç°ã€‚

### æ¯”è¾ƒ `fixedpt` å’Œ `float`

è¿™æ„å‘³ç€æˆ‘ä»¬å‡å®šéœ€è¦è¡¨ç¤ºçš„æ•°ã€è¿ç®—çš„ä¸­é—´ç»“æœä¸ä¼šå¤ªå¤§ä¹Ÿä¸ä¼šå¤ªå°ï¼Œå…·ä½“åœ°ï¼Œæ­£æ•°åœ¨ $[2^{-8}, 2^{23})$ èŒƒå›´å†…ï¼Œè€Œä¸”å¯¹è®¡ç®—ç²¾åº¦è¦æ±‚ä¸å¤ªé«˜ã€‚

### ç¥å¥‡çš„ `fixedpt_rconst`

å®é™…ä¸Šï¼Œä¹˜æ³•çš„æ“ä½œæ•° `FIXEDPT_ONE` çš„ç±»å‹æ˜¯ `int32_t`ã€‚

### å¦‚ä½•å°†æµ®ç‚¹å˜é‡è½¬æ¢æˆ `fixedpt` ç±»å‹?

å› ä¸ºè¯¥ `float` çœŸå€¼è½åœ¨äº† `fixedpt` å¯è¡¨ç¤ºçš„èŒƒå›´ä¸­ï¼Œæ‰€ä»¥ä¸ç”¨è€ƒè™‘ NaNï¼ŒInf è¿˜æœ‰éè§„æ ¼åŒ–æµ®ç‚¹æ•°ã€‚

ä»¥ä¸‹ä¸º `fixedpt_fromfloat(void *p)` çš„å®ç°ã€‚

#TODO

### ç¥å¥‡çš„ `LD_PRELOAD`

è¿™ä¸€é¢˜å°±æ˜¯è§£æå¦‚ä½•å®ç°ç±»ä¼¼ `chroot ${NAVY_HOME}/fsimg` çš„åŠŸèƒ½ï¼Œä¸‹é¢ä»¥ `fopen` çš„å®ç°ä¸ºä¾‹ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼ŒNAVY åº”ç”¨ç¨‹åºè°ƒç”¨ libc çš„ `fopen`ï¼Œç„¶å C åº“å°†å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨ libos ä¸­çš„ `_syscall_` å‘èµ·ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨ native ä¸Šï¼Œå¦‚æœç³»ç»Ÿè°ƒç”¨è¢«æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆç”±äºä¼ é€’ç»™ linux çš„æ–‡ä»¶ä¸ºç›¸å¯¹äº `${NAVY_HOME}/fsimg` ä¸å­˜åœ¨ï¼Œæ–‡ä»¶å°†ä¸èƒ½æ‰“å¼€ã€‚`native.cpp` çš„åšæ³•æ˜¯åœ¨ C åº“å±‚é¢ä¸ŠåŠ«æŒå¯¹ `fopen` çš„è°ƒç”¨ï¼Œåœ¨ç¨‹åºç»™å‡ºçš„è·¯å¾„å‰åŠ ä¸Šå‰ç¼€ï¼Œç„¶åè½¬è€Œä½¿ç”¨ Glibc çš„å®ç°ã€‚

åœ¨ `navy-apps/libs/libos/Makefile` ä¸­ï¼Œå®šä¹‰äº† `native.so` çš„ç¼–è¯‘è§„åˆ™

```Makefile
build/native.so: src/native.cpp
	mkdir -p build/
	g++ -std=c++11 -O1 -fPIC -shared -o build/native.so src/native.cpp -ldl -lSDL2
```

åœ¨ `navy-apps/scripts/native.mk` ä¸­ï¼Œå®šä¹‰äº† native ä¸Šçš„é“¾æ¥è§„åˆ™ï¼Œè®¾ç½®äº†ç¯å¢ƒå˜é‡ `LD_PRELOAD`

```Makefile
run: app env
	@LD_PRELOAD=$(NAVY_HOME)/libs/libos/build/native.so $(APP) $(mainargs)
```

æ ¹æ® [1]ï¼Œâ€œæˆ‘ä»¬å¯ä»¥æŒ‡å®šé¢„å…ˆè£…è½½çš„ä¸€äº›å…±äº«åº“ç”šè‡³æ˜¯ç›®æ ‡æ–‡ä»¶ã€‚åœ¨ `LD_PRELOAD` é‡Œé¢æŒ‡å®šçš„æ–‡ä»¶ä¼šåœ¨åŠ¨æ€é“¾æ¥å™¨æŒ‰ç…§å›ºå®šè§„åˆ™æœç´¢å…±äº«åº“ä¹‹å‰è£…è½½ï¼Œå®ƒæ¯” `LD_LIBRARY_PATH` é‡Œé¢æ‰€æŒ‡å®šçš„ç›®å½•ä¸­çš„å…±äº«åº“è¿˜è¦ä¼˜å…ˆã€‚æ— è®ºç¨‹åºæ˜¯å¦ä¾èµ–å®ƒä»¬ï¼Œ`LD_PRELOAD` é‡Œé¢æŒ‡å®šçš„å…±äº«åº“æˆ–ç›®æ ‡æ–‡ä»¶éƒ½ä¼šè¢«è£…è½½â€

æ ¹æ®åŠ¨æ€é“¾æ¥çš„è§„åˆ™ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥ `fopen` æ—¶ï¼Œé“¾æ¥çš„æ˜¯ `native.cpp` ä¸­ç»™å‡ºçš„ `fopen`ï¼ˆ`native.cpp` ä¸­å†™äº† `extern "C"` é˜²æ­¢ C++ å‡½æ•°åå­—æ”¹å˜ï¼‰ã€‚

#### å‚è€ƒæ–‡çŒ®
- [1] 8.5 ç¯å¢ƒå˜é‡ - ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹

### å®ç°å†…å»ºçš„ `echo` å‘½ä»¤

å·²å®ç°ã€‚

### ä»™å‰‘å¥‡ä¾ ä¼ çš„æ¡†æ¶æ˜¯å¦‚ä½•å·¥ä½œçš„?

#TODO

### ä»™å‰‘å¥‡ä¾ ä¼ çš„è„šæœ¬å¼•æ“

ã€Šä»™å‰‘å¥‡ä¾ ä¼ ã€‹æ˜¯ä¸€ä¸ªçŠ¶æ€æœºğŸ˜‡ã€‚é¦–å…ˆï¼Œå¼€å‘è€…å¼€å‘äº†æ¸¸æˆå¼•æ“ï¼ˆCPUï¼‰ï¼Œå®šä¹‰äº†å„ç§äº‹ä»¶å’Œæ“ä½œï¼ˆISAï¼‰ï¼Œå®ç°äº†æ‰€æœ‰çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆæŒ‡ä»¤ï¼‰ï¼Œç„¶åä¸ºæ¸¸æˆç¼–å†™è„šæœ¬ï¼ˆç¨‹åºï¼‰ã€‚

åœ¨ `navy-apps/apps/pal/repo/include/global.h` ä¸­ï¼Œå®šä¹‰äº†æŒ‡ä»¤æ ¼å¼

```cpp
typedef struct tagSCRIPTENTRY
{
   WORD          wOperation;     // operation code
   WORD          rgwOperand[3];  // operands
} SCRIPTENTRY, *LPSCRIPTENTRY;
```

åœ¨ `navy-apps/apps/pal/repo/src/game/script.c` ä¸­ï¼Œè¿™ä¸ªå·¨å¤§çš„ `switch` å°±æ˜¯æŒ‡ä»¤è¯‘ç ï¼ˆOpcode éƒ¨åˆ†ï¼‰

```cpp
   switch (pScript->wOperation)
   {
   case 0x000B:
   case 0x000C:
   ...
   }
```

### ä¸å†ç¥ç§˜çš„ç§˜æŠ€

æˆ‘æ²¡æœ‰ç©è¿‡ã€Šä»™å‰‘ã€‹ï¼Œåªæ˜¯è´Ÿè´£è®©å®ƒè·‘èµ·æ¥ã€‚å…·ä½“çš„ç»†èŠ‚å¯èƒ½éœ€è¦æŸ¥çœ‹ `.mkf` ä¸­çš„äºŒè¿›åˆ¶è„šæœ¬æ‰è¡Œã€‚ä»”ç»†æ£€æŸ¥äº† PAL ä¸­æ‰€æœ‰åŒ…å« `cash` çš„ä»£ç ï¼Œæ²¡æœ‰å‘ç° bugã€‚

```cpp
   case 0x001E:
      //
      // Increase or decrease cash by the specified amount
      //
      if ((SHORT)(pScript->rgwOperand[0]) < 0 &&
         gpGlobals->dwCash < (WORD)(-(SHORT)(pScript->rgwOperand[0])))
      {
         //
         // not enough cash
         //
         wScriptEntry = pScript->rgwOperand[1] - 1;
      }
      else
      {
         gpGlobals->dwCash += (SHORT)(pScript->rgwOperand[0]);
      }
      break;
```

ä»¥ä¸‹æ˜¯çŒœæµ‹

1. ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªï¼Œä¼¼ä¹éƒ½æ˜¯æ•´æ•°æº¢å‡º Bugã€‚éƒ½æ˜¯é’±æ‰€å‰©æ— å‡ ï¼Œç„¶åå˜ä¸º SHORT è´Ÿæ•°ï¼Œè½¬æ¢è¿‡ç¨‹ä¸­å˜ä¸º DWORDï¼Œç„¶ååˆè½¬æ¢æˆ intï¼Œå°±â€œæš´å¢åˆ°ä¸Šé™äº†â€ï¼›
2. ç¬¬ä¸‰ä¸ªå®åœ¨ä¸æ¸…æ¥šï¼›

### å®ç° Navy ä¸Šçš„ AM

åŠŸèƒ½å·²å®ç°ã€‚

### åœ¨ Navy ä¸­è¿è¡Œ microbench

åœ¨ am-kernel çš„ Makefile ä¸­åŠ å…¥ microbenchï¼Œåœ¨ nterm ä¸­å¯åŠ¨ï¼Œå‘ç°

```
======= Running MicroBench [input *ref*] =======
[qsort] Quick sort: Ignored (insufficient memory)
[queen] Queen placement: * Passed.
  min time: 592.000 ms [687]
[bf] Brainf**k interpreter: Ignored (insufficient memory)
[fib] Fibonacci number: Ignored (insufficient memory)
[sieve] Eratosthenes sieve: Ignored (insufficient memory)
[15pz] A* 15-puzzle search: Ignored (insufficient memory)
[dinic] Dinic's maxflow algorithm: Ignored (insufficient memory)
[lzip] Lzip compression: Ignored (insufficient memory)
[ssort] Suffix sort: Ignored (insufficient memory)
[md5] MD5 digest: Ignored (insufficient memory)
==================================================
MicroBench PASS        68 Marks
                   vs. 100000 Marks (i9-9900K @ 3.60GHz)
Scored time: 592.000 ms
Total  time: 596.000 ms
```

æŠ¥é”™åŸå› æ˜¯ Insufficient memoryï¼ŒçŒœæƒ³å’Œå †ä¸Šçš„å†…å­˜åˆ†é…æœ‰å…³ç³»ï¼ˆå¦‚æœæ˜¯æ ˆç©ºé—´ä¸è¶³ï¼Œç¨‹åºåº”è¯¥ä¼šå‡ºç°è®¿å­˜è¶Šç•Œï¼Œåº”è¯¥ä¼šåœ¨ NEMU ä¸­å‡ºç°éæ³•æŒ‡ä»¤ã€è®¿å­˜è¶Šç•Œé€€å‡ºç­‰ååº”ï¼‰ã€‚åœ¨ 3 ä¸ªæµ‹è¯•çš„æ–‡ä»¶å¤¹ä¸‹æŸ¥æ‰¾æ‰€æœ‰å«æœ‰ `alloc` çš„å†…å®¹ï¼Œå‘ç°åªæœ‰ `microbench` ä½¿ç”¨äº†å †å†…å­˜ã€‚

åœ¨ `am-kernels/benchmarks/microbench/src/bench.c:bench_alloc` ä¸­ï¼Œè·å–äº†å †å†…å­˜çš„å¤§å°

```c
void* bench_alloc(size_t size) {
  size  = (size_t)ROUNDUP(size, 8);
  char *old = hbrk;
  hbrk += size;
  assert((uintptr_t)heap.start <= (uintptr_t)hbrk && (uintptr_t)hbrk < (uintptr_t)heap.end);
  for (uint64_t *p = (uint64_t *)old; p != (uint64_t *)hbrk; p ++) {
    *p = 0;
  }
  assert((uintptr_t)hbrk - (uintptr_t)heap.start <= setting->mlim);
  return old;
}
```

ç„¶è€Œï¼Œåœ¨åŠ è½½ AM ç¨‹åºçš„æ—¶å€™ï¼Œå®ç°çš„ libam å¹¶æ²¡æœ‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ç®¡ç†åˆ†é…å †å†…å­˜ï¼Œå…¨å±€å˜é‡ `Area heap` çš„ `start` å’Œ `end` çš„å€¼éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥æŠ¥å‘Šå†…å­˜ä¸è¶³ã€‚

ä¿®æ”¹ libam çš„å®ç°ï¼ˆç”±äº TRM æ²¡æœ‰åˆå§‹åŒ–å‡½æ•°ï¼Œæˆ‘åœ¨ IOE çš„åˆå§‹åŒ–ä¸­åŠ å…¥äº†å †çš„å¤„ç†ï¼‰ï¼Œåœ¨ç¨‹åºåŠ è½½æ—¶ç”³è¯·è¶³å¤Ÿå¤§çš„å †å†…å­˜ï¼ˆæˆ‘çš„å®ç°ä¸­ç”³è¯·äº† 64Mï¼‰ï¼ŒæˆåŠŸè¿è¡Œ microbenchã€‚

```c
bool ioe_init() {
  heap.start = sbrk(67108864); // ç”³è¯· 64M ç©ºé—´
  heap.end = sbrk(0);
  for (int i = 0; i < LENGTH(lut); i++)
```

### è¿è¡Œ FCEUX

![fceux](img/fceux.png)

### è¯ç”Ÿäº"æœªæ¥"çš„æ¸¸æˆ

![oslab0](img/oslab1.png)
![oslab0](img/oslab2.png)
![oslab0](img/oslab3.png)

æœ‰ä¸€äº›ç¨‹åºä¸èƒ½æ­£å¸¸è¿è¡Œï¼Œæš‚æ—¶æ²¡æœ‰ Debugã€‚

UPD 2023.11.08ï¼šç ´æ¡ˆäº†ï¼Œæ˜¯æ²¡æœ‰ä¸º AM å®ç°å †åŒºï¼Œå®ç°åéƒ½èƒ½æ­£å¸¸è¿è¡Œäº†ã€‚

æœ‰ä¸€äº›ç¨‹åºåˆå§‹åŒ–æ—¶èŠ±å±ï¼Œå°† libam ç”³è¯·çš„å†…å­˜ç½®é›¶ï¼Œé—®é¢˜ä¿®å¤ã€‚

![oslab0](img/oslab4.png)
![oslab0](img/oslab5.png)

### RTFSC???

ä»£ç æ··æ·†æŠ€æœ¯è‚¯å®šè¦ä½¿ç”¨ PA1 è¡¨è¾¾å¼æ±‚å€¼ä¸­çš„ Tokenize æ­¥éª¤çš„æ–¹æ³•ã€‚æˆ‘çŒœæƒ³ä¹Ÿè®¸å¯ä»¥è®©æŸä¸ª C ç¼–è¯‘å™¨å‰ç«¯æ¥å¸®æˆ‘ä»¬åšåˆ°è¿™ä¸€ç‚¹ï¼Œç„¶åå°† AST ä¸­çš„å˜é‡åä¿®æ”¹ä¸€ä¸‹ï¼Œå†è½¬å› C ä»£ç ã€‚

### è®©è¿è¡Œæ—¶ç¯å¢ƒæ”¯æŒ C++ å…¨å±€å¯¹è±¡çš„åˆå§‹åŒ–

åœ¨ `call_main` å‡½æ•°ä¸­æ’å…¥å¯¹ `__libc_init_array` çš„è°ƒç”¨ï¼Œå·²å®ç°ã€‚

### ç†è§£å…¨å±€å¯¹è±¡æ„é€ å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹

æˆ‘æ²¡æœ‰æŒ‰ç…§è®²ä¹‰çš„æ–¹å¼å®Œæˆè¿™é“é¢˜ï¼Œä¹‹å‰åœ¨é˜…è¯» [1] æ—¶ï¼Œè¯»åˆ°äº† Glibc å’Œ GCC å¦‚ä½•åä½œå®Œæˆ C++ å…¨å±€å¯¹è±¡åˆå§‹åŒ–ï¼Œä»¥ä¸‹æ˜¯ç»“è®ºã€‚

`.init_array` èŠ‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œæ˜¯ç”±æ¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„ `.init_array` èŠ‚åˆå¹¶å¾—åˆ°çš„ã€‚è¿™ä¸ªæŒ‡é’ˆæ•°ç»„çš„æ¯ä¸€ä¸ªå…ƒç´ æŒ‡å‘ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ã€‚

STFWï¼Œæ ¹æ® newlib æºç æ³¨é‡Šä¸­çš„æç¤º

```c
/* These magic symbols are provided by the linker.  */
extern void (*__preinit_array_start []) (void) __attribute__((weak));
extern void (*__preinit_array_end []) (void) __attribute__((weak));
extern void (*__init_array_start []) (void) __attribute__((weak));
extern void (*__init_array_end []) (void) __attribute__((weak));
```

ä½¿ç”¨ `readelf -P --string-dump=.rodata /usr/bin/ld | grep '__init_array_start' | uniq` å¯ä»¥å‘ç°åœ¨ ld çš„é»˜è®¤é“¾æ¥è„šæœ¬ä¸­å®šä¹‰äº† `__init_array_start`ï¼ŒæŒ‡å‘çš„å°±æ˜¯ `.init_array` çš„èµ·å§‹ä½ç½®ã€‚

æ‰€ä»¥ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹

1. nanos-lite è°ƒç”¨ `entry`ï¼Œå®é™…æ˜¯ `start.S:_start`ï¼›
2. `_start` è°ƒç”¨ `call_main`ï¼›
3. `call_main` è°ƒç”¨ `__libc_init_array`ï¼Œåˆå§‹åŒ–å…¨å±€å¯¹è±¡ï¼›
4. `call_main` è°ƒç”¨ `main`ï¼›



#### å‚è€ƒæ–‡çŒ®
- [1] [æªå‡ºgccé»˜è®¤ä½¿ç”¨çš„ldé“¾æ¥è„šæœ¬ - é¾™å›¾è…¾](https://blog.csdn.net/dragon101788/article/details/8080747)
- [2] 11.4 C++ å…¨å±€æ„é€ å’Œææ„ - ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ã€‹
